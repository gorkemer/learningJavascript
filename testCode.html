<!DOCTYPE html>
<html>
    <head>
        <title>Boundary Box Motion Task</title>
        <script src="../jspsych-6.0.5/jspsych.js"></script>
        <script src="../jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="../jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
        <link href="../jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <script src="../jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
        <script src="../jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
        <script src="../jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
		    <script src="../jspsych-6.0.5/plugins/jspsych-rdk.js"></script>
        <script src="../jspsych-6.0.5/plugins/jspsych-resize.js"></script>
        <script src="jspsych-canvas-slider-response.js"></script>
        <script src="../jspsych-6.0.5/plugins/jspsych-html-slider-response.js"></script>
        <script src="jspsych-ydk.js"></script>
    </head>
    <body>
    </body>
    <script>

      function saveData() {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'write_data.php'); // change 'write_data.php' to point to php script.
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
          if(xhr.status == 200){
            var response = JSON.parse(xhr.responseText);
            console.log(response.success);
          }
        };
        xhr.send(jsPsych.data.get().json());
      }



      trial_dimensions = []
      width_list = []
      height_list = []
      //dimension_list = [[500, 200, 160]]



      stim1 = [225, 200, 75]
      stim2 = [500, 75, 160]
      stim3 = [450, 150, 200]
      width_list.push(stim1, stim2, stim3)

      stim1 = [50, 100, 200]
      stim2 = [200, 75, 100]
      stim3 = [75, 200, 125]
      height_list.push(stim1, stim2, stim3)

      var i;
      for (i = 0; i < width_list.length; i++) {
      a = {width: width_list[i], height: height_list[i]}
      trial_dimensions.push(a)
      }
      
      //console.log(trial_dimensions)
      // a = {dimensions: dimension_list[0]}
      // b = {dimensions: [100, 200, 75]}
      // c = {dimensions: [150, 75, 200]}
      // trial_dimensions.push(a)
      // trial_dimensions.push(b)
      // trial_dimensions.push(c)
      // console.log(trial_dimensions)

        /* experiment parameters */
      var reps_per_trial_type = 1;


      var survey_trial = {
        type: 'survey-text',
        questions: [{prompt: "Your Name"}],
        on_finish: function(data){
        var responses = JSON.parse(data.responses);
        var code = responses.Q0;
        jsPsych.data.addProperties({participantCode: code}) // update the global variable
        console.log('The trial just finished loading.', code);
        },
        // data: {written: randomGroup}
      }
      
      // jsPsych.data.addProperties({
      // subject: randomGroup,
      // });



        /*set up instructions block*/
        var instructions = {
          type: "instructions",
          pages: [ "<p>test</p>"
            ],
            show_clickable_nav:true
        };

        /*set up welcome block*/
        var lastOne = {
          type: "html-keyboard-response",
          stimulus: "<p>test</p>"
        };



        function drawRect(c){
          var ctx = c.getContext('2d');
          ctx.beginPath();
          ctx.rect(30, 30, 200, 50);
          ctx.stroke();
      }

        var test_block = {
        type: "rdk",
        number_of_apertures: 3, //This needs to be set if more than one aperture
        coherent_direction: 0,
        trial_duration: 1000,
        coherence: 0.7,
        RDK_type: 2, // #6 guzel Applied to all apertures if only one value
        aperture_width: jsPsych.timelineVariable('width'), //Applied to all apertures if only one value
        aperture_height: jsPsych.timelineVariable('height'),
        correct_choice: "P",
        number_of_dots: [200, 200, 200], //Different parameter for each aperture. Array length must equal number_of_apertures
        aperture_center_x: [(window.innerWidth/2)-300,window.innerWidth/2,(window.innerWidth/2)+300], //Separate the apertures on the screen (window.innerWidth/2 is the middle of the screen)
        fixation_cross: true,
        fixation_cross_width: 400,
        fixation_cross_height: 800
        };

        var colors;

        function twoSquares(c, colors) {
            var ctx = c.getContext('2d');
            ctx.fillStyle = colors[0];
            ctx.fillRect(200, 70, 40, 40);
            ctx.fillStyle = colors[1];
            ctx.fillRect(260, 70, 40, 40);
        }


        var ydk_block = {
        type: "ydk",
        number_of_apertures: 3, //This needs to be set if more than one aperture
        coherent_direction: 0,
        trial_duration: 3000,
        coherence: 0.7,
        RDK_type: 2, // #6 guzel Applied to all apertures if only one value
        aperture_width: jsPsych.timelineVariable('width'), //Applied to all apertures if only one value
        aperture_height: jsPsych.timelineVariable('height'),
        correct_choice: "P",
        number_of_dots: [200, 200, 200], //Different parameter for each aperture. Array length must equal number_of_apertures
        aperture_center_x: [(window.innerWidth/2)-300,window.innerWidth/2,(window.innerWidth/2)+300], //Separate the apertures on the screen (window.innerWidth/2 is the middle of the screen)
        fixation_cross: true,
        fixation_cross_width: 400,
        fixation_cross_height: 800,
        labels: ['Tall<br>','Totally<br>Long'],
        canvas_width: 200,
        canvas_height: 100,
        prompt: '<p>How different would you say the colors of these two squares are?</p>',
        stimulus: '<p>Running</p>',
        };

        console.log(typeof ydk_block);

        var slider_trial = {
            type: 'canvas-slider-response',
            stimulus: function(c) {
                colors = ['darkred', 'cyan'];
                twoSquares(c, colors);
            },
            labels: ['Exactly<br>the same','Totally<br>different'],
            canvas_size: [200, 500],
            prompt: '<p>How different would you say the colors of these two squares are?</p>',
            on_finish: function(data) {
                data.color1 = colors[0];
                data.color2 = colors[1];
            }
        };

        var slider_trial_2 = {
            type: 'html-slider-response',
            stimulus: '<p>Running</p>',
            labels: ['healthy', 'unhealthy'],
            prompt: "<p>How healthy/unhealthy is this activity?</p>"
        };

        var inputs = {
        type: 'resize',
        item_width: 3 + 3/8,
        item_height: 2 + 1/8,
        prompt: "<p>Click and drag the lower right corner of the box until the box is the same size as a credit card held up to the screen.</p>",
        pixels_per_unit: 150
      };



        /* defining test timeline */

        /*defining debriefing block*/
        var debrief = {
          type: "html-keyboard-response",
          stimulus: function() {
            var total_trials = Math.round(jsPsych.data.get().filter({trial_type: 'html-keyboard-response'}).count() -2);
            //var total_trials = jsPsych.data.get().filter({trial_type: 'image-keyboard-response'}).count();
            var accuracy = Math.round(jsPsych.data.get().filter({correct: true}).count() / total_trials * 100);
            var congruent_rt = Math.round(jsPsych.data.get().filter({correct: true, stim_type: 'congruent'}).select('rt').mean());
            var incongruent_rt = Math.round(jsPsych.data.get().filter({correct: true, stim_type: 'incongruent'}).select('rt').mean());
            var subjID = jsPsych.data.get().last(1).values()[0]['participantCode']
            return subjID + "," + "<p>You responded correctly on <strong>"+accuracy+"%</strong> of the trials.</p> " + 
            "<p>Your average response time for congruent trials was <strong>" + congruent_rt + "ms</strong>.</p>"+
            "<p>Your average response time for incongruent trials was <strong>" + incongruent_rt + "ms</strong>.</p>"+
            "<p><br>Press any key to complete the experiment. Thank you!</p>";
          }
        };

        /*set up experiment structure*/
        var timeline = [];



        // timeline.push({
        // type: 'fullscreen',
        // fullscreen_mode: true
        // });



        var testProcedure_ellipses = {
        timeline: [test_block, ydk_block, slider_trial_2], //responseFeedback, test_block_response
        timeline_variables: trial_dimensions
        };
        
        timeline.push(instructions);
        //timeline.push(inputs);
        timeline.push(testProcedure_ellipses);
        //timeline.push(test_block);
        //timeline.push(lastOne);
        //timeline.push(survey_trial);
        //timeline.push(test);
        //timeline.push(debrief);


        /*start experiment*/
        jsPsych.init({
            timeline: timeline,
            // show_progress_bar: true,
            on_finish: saveData
        });
    </script>
</html>